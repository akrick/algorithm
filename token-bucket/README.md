# 令牌桶算法

## 算法原理

令牌桶算法是网络流量整形和速率限制中最常用的算法之一。

### 核心概念

1. **令牌桶**：一个固定容量的桶，以恒定速率向桶中添加令牌
2. **令牌**：代表可用的处理资源
3. **请求处理**：请求到达时需要消耗令牌，有令牌则通过，否则被拒绝

### 工作流程

```
┌─────────────┐     恒定速率     ┌─────────────┐
│   令牌源    │ ──────────>    │   令牌桶    │
└─────────────┘                └──────┬──────┘
                                      │
                                      ↓
                              ┌─────────────┐
                              │   请求队列  │
                              └──────┬──────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    ↓                 ↓                 ↓
                ┌───────┐        ┌───────┐        ┌───────┐
                │ 请求1 │        │ 请求2 │        │ 请求3 │
                └───┬───┘        └───┬───┘        └───┬───┘
                    │                │                │
                    ↓                ↓                ↓
                有令牌？        有令牌？        有令牌？
                    ↓                ↓                ↓
                通过/拒绝        通过/拒绝        通过/拒绝
```

### 参数说明

- **capacity**：桶的容量，最多能存储的令牌数
- **rate**：令牌生成速率，每秒生成的令牌数
- **tokens**：当前桶中可用的令牌数

## 使用示例

### 基本使用

```go
// 创建容量为10、速率为5的令牌桶
tb := NewTokenBucket(10, 5)

// 尝试消费3个令牌
if tb.TryConsume(3) {
    fmt.Println("请求通过")
} else {
    fmt.Println("请求被限流")
}
```

### API限流

```go
// 为API接口创建限流器
apiLimiter := NewTokenBucket(100, 50) // 容量100，速率50/秒

func handleRequest() {
    if !apiLimiter.TryConsume(1) {
        http.Error(w, "Too Many Requests", http.StatusTooManyRequests)
        return
    }
    // 处理请求
}
```

## 文件说明

- `token_bucket.go` - 基础令牌桶实现
- `token_bucket_distributed.go` - 分布式令牌桶实现（概念版）
- `token_bucket_test.go` - 演示和测试程序
- `README.md` - 本文档

## 运行测试

```bash
cd algorithm/token-bucket
go run token_bucket_test.go
```

## 特点

### 优点

1. **平滑限流**：允许短时间内的突发流量
2. **灵活配置**：可调整桶容量和速率
3. **实现简单**：算法逻辑清晰易懂

### 适用场景

1. **API限流**：防止API被过度调用
2. **流量控制**：平滑网络流量
3. **系统保护**：防止系统过载

### 与漏桶算法对比

| 特性 | 令牌桶 | 漏桶 |
|------|--------|------|
| 突发流量 | 支持 | 不支持 |
| 流量输出 | 突发 | 恒定 |
| 桶内存储 | 令牌 | 请求 |
| 应用场景 | API限流 | 流量整形 |

## 扩展

- 分布式环境可使用Redis存储令牌状态
- 可结合滑动窗口实现更精确的限流
- 可实现多级令牌桶（分层限流）
