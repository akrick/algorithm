# SingleFlight ç®—æ³•

## æ¦‚è¿°

SingleFlight æ˜¯ä¸€ç§å¹¶å‘æ§åˆ¶æ¨¡å¼,ç”¨äºåˆå¹¶ç›¸åŒçš„å¹¶å‘è¯·æ±‚,é˜²æ­¢å¯¹ç›¸åŒèµ„æºçš„é‡å¤è°ƒç”¨ã€‚

## åŸç†

å½“å¤šä¸ª goroutine åŒæ—¶è¯·æ±‚ç›¸åŒçš„èµ„æºæ—¶:
1. ç¬¬ä¸€ä¸ªè¯·æ±‚æ‰§è¡Œå®é™…çš„è°ƒç”¨æ“ä½œ
2. åç»­çš„ç›¸åŒè¯·æ±‚ä¼šç­‰å¾…ç¬¬ä¸€ä¸ªè¯·æ±‚å®Œæˆ
3. æ‰€æœ‰è¯·æ±‚å…±äº«ç¬¬ä¸€ä¸ªè¯·æ±‚çš„ç»“æœ

## æ ¸å¿ƒç»“æ„

```go
type Group struct {
    mu sync.Mutex
    m  map[string]*call
}

type call struct {
    wg  sync.WaitGroup
    val interface{}
    err error
}
```

## ä¸»è¦æ–¹æ³•

### Do(key string, fn func() (interface{}, error)) (interface{}, error)

åŒæ­¥æ‰§è¡Œå‡½æ•°,ç›¸åŒ key çš„å¹¶å‘è¯·æ±‚ä¼šå…±äº«ç»“æœã€‚

### DoChan(key string, fn func() (interface{}, error)) <-chan Result

å¼‚æ­¥ç‰ˆæœ¬,è¿”å›ä¸€ä¸ª channel ç”¨äºæ¥æ”¶ç»“æœã€‚

### Forget(key string)

ä¸»åŠ¨å–æ¶ˆæŸä¸ª key çš„ç­‰å¾…,ä¸‹æ¬¡ Do ä¼šé‡æ–°æ‰§è¡Œ fnã€‚

## åº”ç”¨åœºæ™¯

- **ç¼“å­˜é˜²å‡»ç©¿**: ç¼“å­˜è¿‡æœŸæ—¶,å¤§é‡å¹¶å‘è¯·æ±‚ä¸ä¼šåŒæ—¶ç©¿é€åˆ°æ•°æ®åº“
- **é‡å¤è¯·æ±‚åˆå¹¶**: å‡å°‘ API è°ƒç”¨æ¬¡æ•°
- **å‡å°‘æ•°æ®åº“æŸ¥è¯¢å‹åŠ›**: ç›¸åŒæŸ¥è¯¢åªæ‰§è¡Œä¸€æ¬¡
- **é™æµé™çº§**: åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ä¿æŠ¤åç«¯æœåŠ¡

## è¿è¡Œç¤ºä¾‹

```bash
# è¿è¡Œå®Œæ•´ç¤ºä¾‹
go run ./algorithm/singleflight/main.go

# è¿è¡Œå•å…ƒæµ‹è¯•
go test -v ./algorithm/singleflight

# è¿è¡Œæ€§èƒ½æµ‹è¯•
go test -bench=. -benchmem ./algorithm/singleflight
```

## è¾“å‡ºç¤ºä¾‹

```
=== SingleFlight ç¼“å­˜é˜²å‡»ç©¿ç¤ºä¾‹ ===

ğŸ”¥ æ¨¡æ‹Ÿç¼“å­˜è¿‡æœŸåçš„å¹¶å‘è¯·æ±‚

âŒ ç¼“å­˜æœªå‘½ä¸­: user:12345
ğŸ“Š æŸ¥è¯¢æ•°æ®åº“: user:12345
âœ… ç¼“å­˜å‘½ä¸­: user:12345
âœ… ç¼“å­˜å‘½ä¸­: user:12345
...

=== ç»Ÿè®¡ä¿¡æ¯ ===
æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°: 1
ç¼“å­˜å‘½ä¸­æ¬¡æ•°: 49
ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°: 1

âœ… æˆåŠŸ! SingleFlight é˜²æ­¢äº†ç¼“å­˜å‡»ç©¿,åªæŸ¥è¯¢äº†ä¸€æ¬¡æ•°æ®åº“
```

## æŠ€æœ¯è¦ç‚¹

1. **æ‡’åŠ è½½**: map åªåœ¨éœ€è¦æ—¶åˆ›å»º
2. **åŒé‡æ£€æŸ¥**: å…ˆæ£€æŸ¥ map,å†æ‰§è¡Œå®é™…è°ƒç”¨
3. **ç»“æœå…±äº«**: æ‰€æœ‰å¹¶å‘è¯·æ±‚å…±äº«åŒä¸€ä¸ªç»“æœ
4. **è‡ªåŠ¨æ¸…ç†**: å®Œæˆåè‡ªåŠ¨ä» map ä¸­ç§»é™¤
5. **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨ sync.Mutex ä¿æŠ¤å…±äº«æ•°æ®

